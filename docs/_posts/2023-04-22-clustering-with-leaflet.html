<html>
    <head>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
            integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
            crossorigin=""/>
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
            integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
            crossorigin="">
        </script>
    
        <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"
            crossorigin="">
        </script>
    
        <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"
            crossorigin=""/>
    
        <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"
            crossorigin=""/>
    
        <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"
            crossorigin="">
        </script>
    
    
        <style>
            #map {
                height: 100%;
            }
    
            .custom-div-icon.sm {
                font-size: 12px;
                font-weight: bold;
                color: black;
            }
    
            .custom-div-icon.md {
                font-size: 14px;
                font-weight: bold;
                color: black;
            }
    
            .custom-div-icon.l {
                font-size: 18px;
                font-weight: bold;
                color: black;
            }
    
            .material-icons.md-18 { 
                font-size: 18px;
                /* color: green; */
                color: orange;
             }
            .material-icons.md-24 { 
                font-size: 24px;
                /* color: green; */
                color: orange;
            }
            .material-icons.md-36 { 
                font-size: 36px;
                color: orange;
            }
            .material-icons.md-48 { 
                font-size: 48px;
                /* color: red; */
                color: orange;
            }
    
            /* .marker-pin {
                width: 30px;
                height: 30px;
                border-radius: 50% 50% 50% 0;
                background: #c30b82;
                position: absolute;
                transform: rotate(-45deg);
                left: 50%;
                top: 50%;
                margin: -15px 0 0 -15px;
            } */
    
            /* .marker-pin::after {
                content: '';
                width: 24px;
                height: 24px;
                margin: 3px 0 0 3px;
                background: #fff;
                position: absolute;
                border-radius: 50%;
            } */
    
            /* .custom-div-icon i {
                position: absolute;
                width: 22px;
                font-size: 22px;
                left: 0;
                right: 0;
                margin: 10px auto;
                text-align: center;
            } */
    
            /* .custom-div-icon i.awesome {
                margin: 12px auto;
                font-size: 17px;
            } */
        </style>
    </head>
    <body>
        <div id="map"></div>
    </body>
    <script type="text/javascript">

        // set view to current location if geolocation is available
        // else fallback to first cam location
        function setView(map, fallBackCoords) {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        map.setView([position.coords.latitude, position.coords.longitude], 9);
                    },
                    (error) => {
                        // maybe access denied
                        map.setView(fallBackCoords, 9);
                    }
                );
            } else {
                /* geolocation IS NOT available */
                map.setView(fallBackCoords, 9);
            }
        }


        const icon =  L.divIcon({
            className: 'custom-div-icon',
            html: "<div style='background-color:#4838cc;' class='marker-pin'></div><i class='material-icons'>photo_camera</i>",
            iconSize: [30, 42],
            iconAnchor: [15, 42]
        });

        var map = L.map('map'); //.setView([51.505, -0.09], 13);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        Papa.parse('https://raw.githubusercontent.com/Open-Oven/mvd_kerala_ai/main/mvd_ai_cams.csv', {
            download: true,
            complete: ({ data: cams }) => {
                // ignore header, for now
                cams = cams.slice(1);
                // the data seems to have some empty rows. santize.
                cams = cams.filter(x => !!x[0].trim());
                const first_cam = cams[0];
                const first_cam_lat_lng = [Number(first_cam[3]), Number(first_cam[4])];
                setView(map, first_cam_lat_lng);

                const clusterGroup = L.markerClusterGroup({
                    iconCreateFunction: function(cluster) {
                        var childCount = cluster.getChildCount();
                        let m = '';
                        if (childCount < 10) {
                            m = 'md-24';
                        } else if (childCount < 100) {
                            m = 'md-36';
                        } else {
                            m = 'md-48';
                        }
                        // return new L.DivIcon({ html: '<div><span>' + childCount + '</span></div>' + `<i class='material-icons ${m}'>photo_camera</i>`, className: 'custom-div-icon ' + c, iconSize: new L.Point(40, 40) });
                        return new L.DivIcon({ html: '<div><span>' + childCount + '</span></div>' + `<i class='material-icons ${m}'>photo_camera</i>`, className: 'custom-div-icon md', iconSize: new L.Point(40, 40) });

                    }
                });
                
                const markers = cams.map(detail => {
                    const lat_ng = [Number(detail[3]), Number(detail[4])];
                    const marker = L.marker(lat_ng, { icon: icon });
                    marker.bindPopup(`<b>Location!</b><br>${detail[2]},${detail[1]}`);
                    clusterGroup.addLayer(marker);
                    return marker;
                });
                map.addLayer(clusterGroup);
            }
        });
        </script>
</html>
